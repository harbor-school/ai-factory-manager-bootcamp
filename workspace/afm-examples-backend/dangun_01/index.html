<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë™ë„¤ì¥í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6F0F',
            'primary-dark': '#E55B00',
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
    .tab-active { color: #FF6F0F; border-color: #FF6F0F; }
    .category-pill { scroll-snap-align: start; }
    .img-carousel { scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
    .img-carousel > div { scroll-snap-align: start; }
    .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen flex flex-col">

  <!-- Auth Screen -->
  <div id="auth-screen" class="flex-1 flex flex-col">
    <div class="pt-16 pb-8 px-6 text-center">
      <div class="text-6xl mb-4">ğŸ¥•</div>
      <h1 class="text-2xl font-bold text-gray-900">ë™ë„¤ì¥í„°</h1>
      <p class="text-gray-500 mt-1">ë‚´ ê·¼ì²˜ì—ì„œ ë§Œë‚˜ëŠ” ì¤‘ê³ ê±°ë˜</p>
    </div>
    <div class="flex border-b mx-6">
      <button id="tab-login" onclick="switchAuthTab('login')" class="flex-1 py-3 text-sm font-semibold border-b-2 tab-active">ë¡œê·¸ì¸</button>
      <button id="tab-register" onclick="switchAuthTab('register')" class="flex-1 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400">íšŒì›ê°€ì…</button>
    </div>
    <form id="login-form" class="px-6 pt-6 flex flex-col gap-3" onsubmit="handleLogin(event)">
      <input id="login-username" type="text" placeholder="ì•„ì´ë””" autocomplete="username"
        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
      <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password"
        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
      <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-primary-dark mt-2">ë¡œê·¸ì¸</button>
    </form>
    <form id="register-form" class="px-6 pt-6 flex flex-col gap-3 hidden" onsubmit="handleRegister(event)">
      <input id="reg-username" type="text" placeholder="ì•„ì´ë””" autocomplete="username"
        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
      <input id="reg-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password"
        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
      <input id="reg-nickname" type="text" placeholder="ë‹‰ë„¤ì„"
        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
      <select id="reg-location"
        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary text-gray-700">
        <option value="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</option>
        <option value="ì„œìš¸ì‹œ ì„œì´ˆêµ¬">ì„œìš¸ì‹œ ì„œì´ˆêµ¬</option>
        <option value="ì„œìš¸ì‹œ ì†¡íŒŒêµ¬">ì„œìš¸ì‹œ ì†¡íŒŒêµ¬</option>
        <option value="ì„œìš¸ì‹œ ë§ˆí¬êµ¬">ì„œìš¸ì‹œ ë§ˆí¬êµ¬</option>
        <option value="ì„œìš¸ì‹œ ìš©ì‚°êµ¬">ì„œìš¸ì‹œ ìš©ì‚°êµ¬</option>
        <option value="ì„œìš¸ì‹œ ì„±ë™êµ¬">ì„œìš¸ì‹œ ì„±ë™êµ¬</option>
        <option value="ì„œìš¸ì‹œ ê´‘ì§„êµ¬">ì„œìš¸ì‹œ ê´‘ì§„êµ¬</option>
        <option value="ì„œìš¸ì‹œ ì¢…ë¡œêµ¬">ì„œìš¸ì‹œ ì¢…ë¡œêµ¬</option>
        <option value="ì„œìš¸ì‹œ ì¤‘êµ¬">ì„œìš¸ì‹œ ì¤‘êµ¬</option>
        <option value="ê²½ê¸°ë„ ì„±ë‚¨ì‹œ">ê²½ê¸°ë„ ì„±ë‚¨ì‹œ</option>
        <option value="ê²½ê¸°ë„ ìˆ˜ì›ì‹œ">ê²½ê¸°ë„ ìˆ˜ì›ì‹œ</option>
        <option value="ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬">ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬</option>
      </select>
      <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-primary-dark mt-2">ê°€ì…í•˜ê¸°</button>
    </form>
    <p id="auth-error" class="text-red-500 text-xs text-center mt-3 px-6 hidden"></p>
  </div>

  <!-- Main Screen -->
  <div id="main-screen" class="flex-1 flex flex-col hidden">
    <!-- Top Header -->
    <header id="main-header" class="flex items-center justify-between px-4 py-3 border-b bg-white sticky top-0 z-10">
      <div class="flex items-center gap-1">
        <span class="text-lg">ğŸ¥•</span>
        <h1 id="header-location" class="text-base font-bold text-gray-900">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</h1>
      </div>
      <div class="flex items-center gap-3">
        <span id="header-nickname" class="text-sm text-gray-600"></span>
        <button onclick="logout()" class="text-xs text-gray-400 hover:text-red-500">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <!-- Sub Header (for detail/form pages) -->
    <header id="sub-header" class="hidden items-center px-4 py-3 border-b bg-white sticky top-0 z-10">
      <button onclick="goBack()" class="text-gray-600 mr-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      </button>
      <h1 id="sub-header-title" class="text-base font-bold text-gray-900"></h1>
    </header>

    <!-- Content Area -->
    <div class="flex-1 overflow-y-auto">

      <!-- Home: Product List -->
      <div id="page-home" class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold">ì¤‘ê³ ê±°ë˜</h2>
        </div>
        <!-- Category Filter -->
        <div class="flex gap-2 overflow-x-auto pb-3 mb-2 -mx-4 px-4" id="category-tabs" style="scrollbar-width:none;-ms-overflow-style:none;">
        </div>
        <!-- Product List -->
        <div id="product-list"></div>
      </div>

      <!-- Product Detail -->
      <div id="page-product-detail" class="hidden">
        <div id="detail-content"></div>
      </div>

      <!-- Product Form -->
      <div id="page-product-form" class="hidden p-4">
        <!-- Image Upload -->
        <div class="mb-4">
          <label class="text-sm font-semibold text-gray-700 mb-2 block">ì‚¬ì§„ (ìµœëŒ€ 5ì¥)</label>
          <div class="flex gap-2 overflow-x-auto pb-2" id="image-preview-area">
            <label id="image-add-btn" class="w-20 h-20 flex-shrink-0 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              <span class="text-[10px] text-gray-400 mt-1" id="image-count">0/5</span>
              <input type="file" accept="image/*" multiple class="hidden" id="image-input" onchange="handleImageSelect(event)" />
            </label>
          </div>
        </div>
        <form id="product-form" class="flex flex-col gap-3" onsubmit="handleProductSubmit(event)">
          <input id="form-title" type="text" placeholder="ê¸€ ì œëª©" maxlength="100"
            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
          <select id="form-category"
            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary text-gray-700">
            <option value="ë””ì§€í„¸ê¸°ê¸°">ë””ì§€í„¸ê¸°ê¸°</option>
            <option value="ìƒí™œê°€ì „">ìƒí™œê°€ì „</option>
            <option value="ê°€êµ¬/ì¸í…Œë¦¬ì–´">ê°€êµ¬/ì¸í…Œë¦¬ì–´</option>
            <option value="ìƒí™œ/ì£¼ë°©">ìƒí™œ/ì£¼ë°©</option>
            <option value="ìœ ì•„ë™">ìœ ì•„ë™</option>
            <option value="ì—¬ì„±ì˜ë¥˜">ì—¬ì„±ì˜ë¥˜</option>
            <option value="ë‚¨ì„±ì˜ë¥˜">ë‚¨ì„±ì˜ë¥˜</option>
            <option value="ë·°í‹°/ë¯¸ìš©">ë·°í‹°/ë¯¸ìš©</option>
            <option value="ìŠ¤í¬ì¸ /ë ˆì €">ìŠ¤í¬ì¸ /ë ˆì €</option>
            <option value="ì·¨ë¯¸/ê²Œì„/ìŒë°˜">ì·¨ë¯¸/ê²Œì„/ìŒë°˜</option>
            <option value="ë„ì„œ">ë„ì„œ</option>
            <option value="ë°˜ë ¤ë™ë¬¼ìš©í’ˆ">ë°˜ë ¤ë™ë¬¼ìš©í’ˆ</option>
            <option value="ì‹ë¬¼">ì‹ë¬¼</option>
            <option value="ê¸°íƒ€" selected>ê¸°íƒ€</option>
          </select>
          <div class="relative">
            <input id="form-price" type="number" placeholder="ê°€ê²©" min="0"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary pr-10" />
            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-gray-400">ì›</span>
          </div>
          <textarea id="form-description" placeholder="ê²Œì‹œê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.&#10;(ìƒí’ˆ ìƒíƒœ, ê±°ë˜ ë°©ë²• ë“±)" rows="5"
            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary resize-none"></textarea>
          <!-- Status (only for edit) -->
          <div id="form-status-wrap" class="hidden">
            <label class="text-sm font-semibold text-gray-700 mb-1 block">íŒë§¤ ìƒíƒœ</label>
            <div class="flex gap-2">
              <button type="button" onclick="selectStatus('íŒë§¤ì¤‘')" data-status="íŒë§¤ì¤‘" class="status-btn flex-1 py-2 rounded-xl text-sm font-semibold border-2 border-primary text-primary bg-primary/5">íŒë§¤ì¤‘</button>
              <button type="button" onclick="selectStatus('ì˜ˆì•½ì¤‘')" data-status="ì˜ˆì•½ì¤‘" class="status-btn flex-1 py-2 rounded-xl text-sm font-semibold border-2 border-gray-200 text-gray-500">ì˜ˆì•½ì¤‘</button>
              <button type="button" onclick="selectStatus('ê±°ë˜ì™„ë£Œ')" data-status="ê±°ë˜ì™„ë£Œ" class="status-btn flex-1 py-2 rounded-xl text-sm font-semibold border-2 border-gray-200 text-gray-500">ê±°ë˜ì™„ë£Œ</button>
            </div>
          </div>
          <button type="submit" id="form-submit-btn" class="w-full py-3 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-primary-dark mt-1">ì‘ì„± ì™„ë£Œ</button>
        </form>
      </div>

      <!-- Profile Tab -->
      <div id="page-profile" class="p-4 hidden">
        <h2 class="text-lg font-bold mb-4">ë‚´ í”„ë¡œí•„</h2>
        <div class="bg-gray-50 rounded-2xl p-5">
          <div class="flex items-center gap-4 mb-5">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center text-2xl">ğŸ§‘</div>
            <div>
              <p id="profile-nickname" class="font-bold text-gray-900"></p>
              <p id="profile-username" class="text-xs text-gray-400"></p>
            </div>
          </div>
          <div class="flex items-center gap-2 mb-4 text-sm text-gray-600">
            <span>ğŸ“</span>
            <span id="profile-location"></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <span>ğŸ“…</span>
            <span id="profile-date"></span>
          </div>
        </div>

        <!-- My Products -->
        <div class="mt-6">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">ë‚´ íŒë§¤ ëª©ë¡</h3>
          <div id="my-product-list"></div>
        </div>

        <!-- Edit Profile -->
        <div class="mt-6">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">í”„ë¡œí•„ ìˆ˜ì •</h3>
          <form id="profile-form" class="flex flex-col gap-3" onsubmit="handleProfileUpdate(event)">
            <input id="edit-nickname" type="text" placeholder="ë‹‰ë„¤ì„"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary" />
            <select id="edit-location"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary text-gray-700">
              <option value="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</option>
              <option value="ì„œìš¸ì‹œ ì„œì´ˆêµ¬">ì„œìš¸ì‹œ ì„œì´ˆêµ¬</option>
              <option value="ì„œìš¸ì‹œ ì†¡íŒŒêµ¬">ì„œìš¸ì‹œ ì†¡íŒŒêµ¬</option>
              <option value="ì„œìš¸ì‹œ ë§ˆí¬êµ¬">ì„œìš¸ì‹œ ë§ˆí¬êµ¬</option>
              <option value="ì„œìš¸ì‹œ ìš©ì‚°êµ¬">ì„œìš¸ì‹œ ìš©ì‚°êµ¬</option>
              <option value="ì„œìš¸ì‹œ ì„±ë™êµ¬">ì„œìš¸ì‹œ ì„±ë™êµ¬</option>
              <option value="ì„œìš¸ì‹œ ê´‘ì§„êµ¬">ì„œìš¸ì‹œ ê´‘ì§„êµ¬</option>
              <option value="ì„œìš¸ì‹œ ì¢…ë¡œêµ¬">ì„œìš¸ì‹œ ì¢…ë¡œêµ¬</option>
              <option value="ì„œìš¸ì‹œ ì¤‘êµ¬">ì„œìš¸ì‹œ ì¤‘êµ¬</option>
              <option value="ê²½ê¸°ë„ ì„±ë‚¨ì‹œ">ê²½ê¸°ë„ ì„±ë‚¨ì‹œ</option>
              <option value="ê²½ê¸°ë„ ìˆ˜ì›ì‹œ">ê²½ê¸°ë„ ìˆ˜ì›ì‹œ</option>
              <option value="ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬">ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬</option>
            </select>
            <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-primary-dark">ì €ì¥</button>
            <p id="profile-msg" class="text-xs text-center hidden"></p>
          </form>
        </div>
      </div>
    </div>

    <!-- FAB: Add Product -->
    <button id="fab-add" onclick="openProductForm()" class="fixed bottom-20 right-4 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-primary-dark z-20" style="max-width:calc(448px - 16px);right:max(16px, calc((100vw - 448px)/2 + 16px))">
      +
    </button>

    <!-- Bottom Tab Bar -->
    <nav id="bottom-tabs" class="flex border-t bg-white sticky bottom-0">
      <button onclick="switchTab('home')" id="btn-home" class="flex-1 flex flex-col items-center py-2 text-primary">
        <span class="text-xl">ğŸ </span>
        <span class="text-[10px] mt-0.5 font-semibold">í™ˆ</span>
      </button>
      <button onclick="switchTab('profile')" id="btn-profile" class="flex-1 flex flex-col items-center py-2 text-gray-400">
        <span class="text-xl">ğŸ‘¤</span>
        <span class="text-[10px] mt-0.5">ë‚´ í”„ë¡œí•„</span>
      </button>
    </nav>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm px-5 py-2.5 rounded-xl shadow-lg hidden z-50"></div>

<script>
// --- Constants ---
const CATEGORIES = ['ì „ì²´','ë””ì§€í„¸ê¸°ê¸°','ìƒí™œê°€ì „','ê°€êµ¬/ì¸í…Œë¦¬ì–´','ìƒí™œ/ì£¼ë°©','ìœ ì•„ë™','ì—¬ì„±ì˜ë¥˜','ë‚¨ì„±ì˜ë¥˜','ë·°í‹°/ë¯¸ìš©','ìŠ¤í¬ì¸ /ë ˆì €','ì·¨ë¯¸/ê²Œì„/ìŒë°˜','ë„ì„œ','ë°˜ë ¤ë™ë¬¼ìš©í’ˆ','ì‹ë¬¼','ê¸°íƒ€'];
const MAX_IMAGES = 5;

// --- State ---
let token = localStorage.getItem('dangun_token');
let currentUser = null;
let currentPage = 'home';
let pageHistory = [];
let selectedCategory = 'ì „ì²´';
let editingProduct = null;
let formImages = []; // Supabase public URLs
let formSelectedStatus = 'íŒë§¤ì¤‘';
let products = [];

// --- API Helper ---
async function api(method, url, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (token) opts.headers['Authorization'] = `Bearer ${token}`;
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || 'ìš”ì²­ ì‹¤íŒ¨');
  return data;
}

// --- Toast ---
function toast(msg, isError = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `fixed top-4 left-1/2 -translate-x-1/2 text-white text-sm px-5 py-2.5 rounded-xl shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
  setTimeout(() => el.classList.add('hidden'), 2000);
}

// --- Helpers ---
function timeAgo(dateStr) {
  const now = new Date();
  const date = new Date(dateStr);
  const diff = Math.floor((now - date) / 1000);
  if (diff < 60) return 'ë°©ê¸ˆ ì „';
  if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
  if (diff < 604800) return `${Math.floor(diff / 86400)}ì¼ ì „`;
  return date.toLocaleDateString('ko-KR');
}

function formatPrice(price) {
  return parseInt(price).toLocaleString() + 'ì›';
}

function statusColor(status) {
  if (status === 'ì˜ˆì•½ì¤‘') return 'bg-green-100 text-green-700';
  if (status === 'ê±°ë˜ì™„ë£Œ') return 'bg-gray-200 text-gray-500';
  return '';
}

// --- Image Compression ---
function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let { width, height } = img;
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// --- Auth ---
function switchAuthTab(tab) {
  const isLogin = tab === 'login';
  document.getElementById('login-form').classList.toggle('hidden', !isLogin);
  document.getElementById('register-form').classList.toggle('hidden', isLogin);
  document.getElementById('tab-login').classList.toggle('tab-active', isLogin);
  document.getElementById('tab-register').classList.toggle('tab-active', !isLogin);
  document.getElementById('tab-login').classList.toggle('text-gray-400', !isLogin);
  document.getElementById('tab-register').classList.toggle('text-gray-400', isLogin);
  document.getElementById('tab-login').classList.toggle('border-transparent', !isLogin);
  document.getElementById('tab-register').classList.toggle('border-transparent', isLogin);
  document.getElementById('auth-error').classList.add('hidden');
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.remove('hidden');
}

async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) return showAuthError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
  try {
    const res = await api('POST', '/api/auth/login', { username, password });
    token = res.data.token;
    localStorage.setItem('dangun_token', token);
    currentUser = res.data.user;
    showMainScreen();
    toast(`${currentUser.nickname}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
  } catch (err) {
    showAuthError(err.message);
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const nickname = document.getElementById('reg-nickname').value.trim();
  const location = document.getElementById('reg-location').value;
  if (!username || !password || !nickname) return showAuthError('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  if (password.length < 4) return showAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
  try {
    const res = await api('POST', '/api/auth/register', { username, password, nickname });
    token = res.data.token;
    localStorage.setItem('dangun_token', token);
    if (location !== 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬') {
      await api('PUT', '/api/auth/profile', { location });
    }
    currentUser = { ...res.data.user, location };
    showMainScreen();
    toast('ê°€ì… ì™„ë£Œ! ë™ë„¤ì¥í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤');
  } catch (err) {
    showAuthError(err.message);
  }
}

function logout() {
  token = null;
  currentUser = null;
  localStorage.removeItem('dangun_token');
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('main-screen').classList.add('hidden');
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  switchAuthTab('login');
}

// --- Navigation ---
function showMainScreen() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('main-screen').classList.remove('hidden');
  document.getElementById('header-nickname').textContent = currentUser.nickname;
  document.getElementById('header-location').textContent = currentUser.location || 'ë™ë„¤ ì„¤ì •';
  renderCategoryTabs();
  renderProfile();
  navigateTo('home');
}

function navigateTo(page, data) {
  if (currentPage !== page) {
    pageHistory.push(currentPage);
  }
  currentPage = page;
  showPage(page, data);
}

function goBack() {
  const prev = pageHistory.pop() || 'home';
  currentPage = prev;
  showPage(prev);
}

function showPage(page, data) {
  // Hide all pages
  document.getElementById('page-home').classList.add('hidden');
  document.getElementById('page-product-detail').classList.add('hidden');
  document.getElementById('page-product-form').classList.add('hidden');
  document.getElementById('page-profile').classList.add('hidden');

  // Header toggling
  const isSubPage = page === 'product-detail' || page === 'product-form';
  document.getElementById('main-header').classList.toggle('hidden', isSubPage);
  document.getElementById('main-header').classList.toggle('flex', !isSubPage);
  document.getElementById('sub-header').classList.toggle('hidden', !isSubPage);
  document.getElementById('sub-header').classList.toggle('flex', isSubPage);
  document.getElementById('bottom-tabs').classList.toggle('hidden', isSubPage);
  document.getElementById('fab-add').classList.toggle('hidden', isSubPage);

  // Show target page
  if (page === 'home') {
    document.getElementById('page-home').classList.remove('hidden');
    loadProducts();
    updateTabButtons('home');
  } else if (page === 'product-detail') {
    document.getElementById('page-product-detail').classList.remove('hidden');
    document.getElementById('sub-header-title').textContent = '';
    if (data) renderProductDetail(data);
  } else if (page === 'product-form') {
    document.getElementById('page-product-form').classList.remove('hidden');
    document.getElementById('sub-header-title').textContent = editingProduct ? 'ê²Œì‹œê¸€ ìˆ˜ì •' : 'ë‚´ ë¬¼ê±´ íŒ”ê¸°';
  } else if (page === 'profile') {
    document.getElementById('page-profile').classList.remove('hidden');
    renderProfile();
    loadMyProducts();
    updateTabButtons('profile');
  }
}

function switchTab(tab) {
  pageHistory = [];
  currentPage = tab;
  showPage(tab);
}

function updateTabButtons(tab) {
  document.getElementById('btn-home').classList.toggle('text-primary', tab === 'home');
  document.getElementById('btn-home').classList.toggle('text-gray-400', tab !== 'home');
  document.getElementById('btn-profile').classList.toggle('text-primary', tab === 'profile');
  document.getElementById('btn-profile').classList.toggle('text-gray-400', tab !== 'profile');
}

// --- Category Tabs ---
function renderCategoryTabs() {
  const container = document.getElementById('category-tabs');
  container.innerHTML = CATEGORIES.map(cat => `
    <button onclick="filterCategory('${cat}')"
      class="category-pill flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap
        ${cat === selectedCategory ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
      ${cat}
    </button>
  `).join('');
}

function filterCategory(cat) {
  selectedCategory = cat;
  renderCategoryTabs();
  loadProducts();
}

// --- Product List ---
async function loadProducts() {
  try {
    const params = selectedCategory !== 'ì „ì²´' ? `?category=${encodeURIComponent(selectedCategory)}` : '';
    const res = await api('GET', '/api/products' + params);
    products = res.data;
    renderProductList(products);
  } catch (err) {
    console.error('Load products error:', err);
  }
}

function renderProductList(items) {
  const container = document.getElementById('product-list');
  if (items.length === 0) {
    container.innerHTML = `
      <div class="flex flex-col items-center justify-center py-20 text-gray-400">
        <div class="text-5xl mb-4">ğŸ“¦</div>
        <p class="text-sm">ì•„ì§ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ì–´ìš”</p>
        <p class="text-xs mt-1">ì²« ë²ˆì§¸ ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
      </div>`;
    return;
  }
  container.innerHTML = items.map(p => {
    const imgs = typeof p.images === 'string' ? JSON.parse(p.images) : (p.images || []);
    const thumb = imgs.length > 0
      ? `<img src="${imgs[0]}" class="w-full h-full object-cover" alt="" />`
      : `<div class="w-full h-full bg-gray-100 flex items-center justify-center text-3xl text-gray-300">ğŸ“·</div>`;
    const badge = p.status !== 'íŒë§¤ì¤‘'
      ? `<span class="status-badge ${statusColor(p.status)} font-semibold">${p.status}</span>`
      : '';
    return `
      <div onclick="openProductDetail(${p.id})" class="flex gap-4 py-4 border-b border-gray-100 cursor-pointer active:bg-gray-50">
        <div class="w-28 h-28 flex-shrink-0 rounded-xl overflow-hidden bg-gray-100">${thumb}</div>
        <div class="flex-1 min-w-0 flex flex-col justify-between py-0.5">
          <div>
            <div class="flex items-center gap-1.5">
              ${badge}
              <h3 class="text-sm font-medium text-gray-900 truncate">${p.title}</h3>
            </div>
            <p class="text-xs text-gray-400 mt-1">${p.location} Â· ${timeAgo(p.created_at)}</p>
          </div>
          <p class="text-[15px] font-bold text-gray-900">${formatPrice(p.price)}</p>
        </div>
      </div>`;
  }).join('');
}

// --- Product Detail ---
async function openProductDetail(id) {
  try {
    const res = await api('GET', `/api/products/${id}`);
    navigateTo('product-detail', res.data);
  } catch (err) {
    toast(err.message, true);
  }
}

function renderProductDetail(p) {
  const imgs = typeof p.images === 'string' ? JSON.parse(p.images) : (p.images || []);
  const isOwner = currentUser && currentUser.id === p.user_id;

  let imageHTML;
  if (imgs.length > 0) {
    imageHTML = `
      <div class="relative">
        <div class="img-carousel flex overflow-x-auto" style="scrollbar-width:none;">
          ${imgs.map((src, i) => `
            <div class="w-full flex-shrink-0">
              <img src="${src}" class="w-full h-72 object-cover" alt="ìƒí’ˆ ì´ë¯¸ì§€ ${i + 1}" />
            </div>
          `).join('')}
        </div>
        ${imgs.length > 1 ? `<div class="absolute bottom-3 right-3 bg-black/50 text-white text-xs px-2 py-1 rounded-full">1/${imgs.length}</div>` : ''}
      </div>`;
  } else {
    imageHTML = `<div class="w-full h-48 bg-gray-100 flex items-center justify-center text-5xl text-gray-300">ğŸ“·</div>`;
  }

  const badge = p.status !== 'íŒë§¤ì¤‘'
    ? `<span class="inline-block status-badge ${statusColor(p.status)} font-semibold mb-2">${p.status}</span><br/>`
    : '';

  const ownerActions = isOwner ? `
    <div class="flex gap-2 mt-4">
      <button onclick="openEditProduct(${p.id})" class="flex-1 py-2.5 border-2 border-primary text-primary rounded-xl text-sm font-semibold hover:bg-primary/5">ìˆ˜ì •</button>
      <button onclick="deleteProduct(${p.id})" class="flex-1 py-2.5 border-2 border-red-400 text-red-500 rounded-xl text-sm font-semibold hover:bg-red-50">ì‚­ì œ</button>
    </div>` : '';

  document.getElementById('detail-content').innerHTML = `
    ${imageHTML}
    <div class="p-4">
      <!-- Seller Info -->
      <div class="flex items-center gap-3 pb-4 border-b border-gray-100">
        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center text-lg">ğŸ§‘</div>
        <div>
          <p class="text-sm font-semibold text-gray-900">${p.nickname}</p>
          <p class="text-xs text-gray-400">${p.location}</p>
        </div>
      </div>
      <!-- Product Info -->
      <div class="py-4">
        ${badge}
        <h2 class="text-lg font-bold text-gray-900">${p.title}</h2>
        <p class="text-xs text-gray-400 mt-1">${p.category} Â· ${timeAgo(p.created_at)}</p>
        <p class="text-xl font-bold text-gray-900 mt-3">${formatPrice(p.price)}</p>
        <p class="text-sm text-gray-700 mt-4 whitespace-pre-wrap leading-relaxed">${p.description || ''}</p>
      </div>
      ${ownerActions}
    </div>`;

  // Image carousel indicator
  if (imgs.length > 1) {
    const carousel = document.querySelector('.img-carousel');
    const indicator = document.querySelector('.img-carousel + div') || carousel.parentElement.querySelector('.absolute');
    if (carousel && indicator) {
      carousel.addEventListener('scroll', () => {
        const idx = Math.round(carousel.scrollLeft / carousel.clientWidth) + 1;
        indicator.textContent = `${idx}/${imgs.length}`;
      });
    }
  }
}

async function deleteProduct(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await api('DELETE', `/api/products/${id}`);
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    goBack();
  } catch (err) {
    toast(err.message, true);
  }
}

// --- Product Form ---
function openProductForm() {
  editingProduct = null;
  formImages = [];
  formSelectedStatus = 'íŒë§¤ì¤‘';
  document.getElementById('form-title').value = '';
  document.getElementById('form-category').value = 'ê¸°íƒ€';
  document.getElementById('form-price').value = '';
  document.getElementById('form-description').value = '';
  document.getElementById('form-status-wrap').classList.add('hidden');
  document.getElementById('form-submit-btn').textContent = 'ì‘ì„± ì™„ë£Œ';
  document.getElementById('image-input').value = '';
  renderImagePreviews();
  navigateTo('product-form');
}

async function openEditProduct(id) {
  try {
    const res = await api('GET', `/api/products/${id}`);
    const p = res.data;
    editingProduct = p;
    formImages = typeof p.images === 'string' ? JSON.parse(p.images) : (p.images || []);
    formSelectedStatus = p.status;
    document.getElementById('form-title').value = p.title;
    document.getElementById('form-category').value = p.category;
    document.getElementById('form-price').value = p.price;
    document.getElementById('form-description').value = p.description || '';
    document.getElementById('form-status-wrap').classList.remove('hidden');
    document.getElementById('form-submit-btn').textContent = 'ìˆ˜ì • ì™„ë£Œ';
    selectStatus(p.status);
    renderImagePreviews();
    navigateTo('product-form');
  } catch (err) {
    toast(err.message, true);
  }
}

function selectStatus(status) {
  formSelectedStatus = status;
  document.querySelectorAll('.status-btn').forEach(btn => {
    const isActive = btn.dataset.status === status;
    btn.classList.toggle('border-primary', isActive);
    btn.classList.toggle('text-primary', isActive);
    btn.classList.toggle('bg-primary/5', isActive);
    btn.classList.toggle('border-gray-200', !isActive);
    btn.classList.toggle('text-gray-500', !isActive);
  });
}

let uploadingCount = 0;

async function handleImageSelect(e) {
  const files = Array.from(e.target.files);
  if (formImages.length + files.length > MAX_IMAGES) {
    toast(`ì‚¬ì§„ì€ ìµœëŒ€ ${MAX_IMAGES}ì¥ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤`, true);
    e.target.value = '';
    return;
  }
  e.target.value = '';

  for (const file of files) {
    try {
      uploadingCount++;
      renderImagePreviews();
      const compressed = await compressImage(file);
      const res = await api('POST', '/api/upload', { image: compressed });
      formImages.push(res.data.url);
    } catch (err) {
      console.error('Image upload error:', err);
      toast('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', true);
    } finally {
      uploadingCount--;
    }
  }
  renderImagePreviews();
}

function removeImage(index) {
  formImages.splice(index, 1);
  renderImagePreviews();
}

function renderImagePreviews() {
  const area = document.getElementById('image-preview-area');
  const addBtn = document.getElementById('image-add-btn');
  // Remove existing previews (keep add button)
  area.querySelectorAll('.img-thumb').forEach(el => el.remove());
  // Insert previews before add button
  formImages.forEach((src, i) => {
    const div = document.createElement('div');
    div.className = 'img-thumb w-20 h-20 flex-shrink-0 rounded-xl overflow-hidden relative';
    div.innerHTML = `
      <img src="${src}" class="w-full h-full object-cover" alt="" />
      <button onclick="removeImage(${i})" class="absolute top-1 right-1 w-5 h-5 bg-black/60 text-white rounded-full text-xs flex items-center justify-center">&times;</button>
      ${i === 0 ? '<span class="absolute bottom-0 left-0 right-0 bg-primary text-white text-[9px] text-center py-0.5">ëŒ€í‘œ</span>' : ''}
    `;
    area.insertBefore(div, addBtn);
  });
  // Show uploading placeholders
  for (let i = 0; i < uploadingCount; i++) {
    const div = document.createElement('div');
    div.className = 'img-thumb w-20 h-20 flex-shrink-0 rounded-xl overflow-hidden relative bg-gray-100 flex items-center justify-center';
    div.innerHTML = '<div class="animate-spin w-5 h-5 border-2 border-primary border-t-transparent rounded-full"></div>';
    area.insertBefore(div, addBtn);
  }
  const totalCount = formImages.length + uploadingCount;
  document.getElementById('image-count').textContent = `${totalCount}/${MAX_IMAGES}`;
  addBtn.classList.toggle('hidden', totalCount >= MAX_IMAGES);
}

async function handleProductSubmit(e) {
  e.preventDefault();
  const title = document.getElementById('form-title').value.trim();
  const category = document.getElementById('form-category').value;
  const price = document.getElementById('form-price').value;
  const description = document.getElementById('form-description').value.trim();

  if (!title) return toast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true);
  if (price === '' || price === undefined) return toast('ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true);
  if (uploadingCount > 0) return toast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”', true);

  const body = { title, category, price: parseInt(price), description, images: formImages };

  try {
    if (editingProduct) {
      body.status = formSelectedStatus;
      await api('PUT', `/api/products/${editingProduct.id}`, body);
      toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
      await api('POST', '/api/products', body);
      toast('ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    // Go back to previous page
    editingProduct = null;
    formImages = [];
    pageHistory = [];
    currentPage = 'home';
    showPage('home');
  } catch (err) {
    toast(err.message, true);
  }
}

// --- Profile ---
function renderProfile() {
  if (!currentUser) return;
  document.getElementById('profile-nickname').textContent = currentUser.nickname;
  document.getElementById('profile-username').textContent = '@' + currentUser.username;
  document.getElementById('profile-location').textContent = currentUser.location || 'ë¯¸ì„¤ì •';
  document.getElementById('profile-date').textContent = currentUser.created_at
    ? new Date(currentUser.created_at).toLocaleDateString('ko-KR') + ' ê°€ì…'
    : '';
  document.getElementById('edit-nickname').value = currentUser.nickname;
  document.getElementById('edit-location').value = currentUser.location || 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬';
}

async function loadMyProducts() {
  if (!currentUser) return;
  try {
    const res = await api('GET', `/api/products?user_id=${currentUser.id}`);
    const container = document.getElementById('my-product-list');
    const items = res.data;
    if (items.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
      return;
    }
    container.innerHTML = items.map(p => {
      const imgs = typeof p.images === 'string' ? JSON.parse(p.images) : (p.images || []);
      const thumb = imgs.length > 0
        ? `<img src="${imgs[0]}" class="w-full h-full object-cover" alt="" />`
        : `<div class="w-full h-full bg-gray-100 flex items-center justify-center text-lg text-gray-300">ğŸ“·</div>`;
      const badge = p.status !== 'íŒë§¤ì¤‘'
        ? `<span class="status-badge ${statusColor(p.status)} font-semibold">${p.status}</span> `
        : '';
      return `
        <div onclick="openProductDetail(${p.id})" class="flex gap-3 py-3 border-b border-gray-100 cursor-pointer">
          <div class="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden">${thumb}</div>
          <div class="flex-1 min-w-0 flex flex-col justify-between">
            <p class="text-sm text-gray-900 truncate">${badge}${p.title}</p>
            <p class="text-sm font-bold text-gray-900">${formatPrice(p.price)}</p>
          </div>
        </div>`;
    }).join('');
  } catch (err) {
    console.error('Load my products error:', err);
  }
}

async function handleProfileUpdate(e) {
  e.preventDefault();
  const nickname = document.getElementById('edit-nickname').value.trim();
  const location = document.getElementById('edit-location').value;
  if (!nickname) return toast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', true);
  try {
    const res = await api('PUT', '/api/auth/profile', { nickname, location });
    currentUser = { ...currentUser, ...res.data };
    document.getElementById('header-nickname').textContent = currentUser.nickname;
    document.getElementById('header-location').textContent = currentUser.location;
    renderProfile();
    const msg = document.getElementById('profile-msg');
    msg.textContent = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤';
    msg.className = 'text-xs text-center text-green-600';
    setTimeout(() => msg.classList.add('hidden'), 2000);
    toast('í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (err) {
    toast(err.message, true);
  }
}

// --- Init ---
(async function init() {
  if (!token) return;
  try {
    const res = await api('GET', '/api/auth/me');
    currentUser = res.data;
    showMainScreen();
  } catch {
    logout();
  }
})();
</script>
</body>
</html>

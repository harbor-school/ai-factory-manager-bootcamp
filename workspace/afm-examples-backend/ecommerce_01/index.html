<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LUEUR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['Playfair Display', 'Georgia', 'serif'],
          },
          colors: {
            brand: { DEFAULT: '#1a1a1a', light: '#666', muted: '#999', bg: '#fafafa', border: '#e5e5e5' },
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fff; color: #1a1a1a; }
    .font-brand { font-family: 'Playfair Display', Georgia, serif; }
    input:focus, select:focus { outline: none; border-color: #1a1a1a; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .divider { height: 1px; background: #e5e5e5; }
    .kakao-btn { background: #FEE500; color: #000000; }
    .kakao-btn:hover { background: #F5DC00; }
  </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen flex flex-col">

  <!-- Auth Screen -->
  <div id="auth-screen" class="flex-1 flex flex-col">
    <!-- Login Page -->
    <div id="page-login" class="flex-1 flex flex-col fade-in">
      <div class="flex-1 flex flex-col justify-center px-8">
        <!-- Brand -->
        <div class="text-center mb-12">
          <h1 class="font-brand text-4xl tracking-wider mb-2">LUEUR</h1>
          <p class="text-xs text-brand-muted tracking-widest uppercase">La beaut&eacute; naturelle</p>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="flex flex-col gap-3" onsubmit="handleLogin(event)">
          <input id="login-username" type="text" placeholder="아이디" autocomplete="username"
            class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          <input id="login-password" type="password" placeholder="비밀번호" autocomplete="current-password"
            class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          <button type="submit" class="w-full py-3.5 bg-brand text-white text-sm font-medium tracking-wider mt-1 hover:bg-black transition-colors">
            로그인
          </button>
        </form>

        <p id="login-error" class="text-red-500 text-xs text-center mt-3 hidden"></p>

        <!-- Divider -->
        <div class="flex items-center gap-4 my-6">
          <div class="flex-1 divider"></div>
          <span class="text-xs text-brand-muted">또는</span>
          <div class="flex-1 divider"></div>
        </div>

        <!-- Kakao Login -->
        <button id="kakao-login-btn" onclick="handleKakaoLogin()" class="kakao-btn w-full py-3.5 text-sm font-medium tracking-wide flex items-center justify-center gap-2 hidden">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#000" d="M9 1C4.58 1 1 3.79 1 7.21c0 2.17 1.44 4.08 3.62 5.17-.16.56-.57 2.03-.66 2.35-.1.39.15.39.31.28.13-.08 2.01-1.36 2.82-1.91.6.09 1.22.13 1.85.13 4.42 0 8-2.79 8-6.23C17 3.79 13.42 1 9 1"/></svg>
          카카오로 시작하기
        </button>

        <!-- Register Link -->
        <div class="text-center mt-8">
          <p class="text-xs text-brand-muted">
            아직 회원이 아니신가요?
            <button onclick="showPage('register')" class="text-brand font-medium underline underline-offset-2 ml-1">회원가입</button>
          </p>
        </div>
      </div>
    </div>

    <!-- Register Page -->
    <div id="page-register" class="flex-1 flex flex-col hidden fade-in">
      <!-- Header -->
      <header class="flex items-center px-4 py-3 border-b border-brand-border">
        <button onclick="showPage('login')" class="text-brand mr-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <h1 class="text-sm font-medium tracking-wide">회원가입</h1>
      </header>

      <div class="flex-1 px-8 pt-8">
        <!-- Brand -->
        <div class="text-center mb-8">
          <h2 class="font-brand text-2xl tracking-wider mb-1">Join LUEUR</h2>
          <p class="text-xs text-brand-muted">당신의 아름다움을 시작하세요</p>
        </div>

        <form id="register-form" class="flex flex-col gap-3" onsubmit="handleRegister(event)">
          <div>
            <label class="text-xs text-brand-light mb-1 block tracking-wide">아이디 *</label>
            <input id="reg-username" type="text" placeholder="영문, 숫자 4자 이상" autocomplete="username"
              class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          </div>
          <div>
            <label class="text-xs text-brand-light mb-1 block tracking-wide">비밀번호 *</label>
            <input id="reg-password" type="password" placeholder="6자 이상" autocomplete="new-password"
              class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          </div>
          <div>
            <label class="text-xs text-brand-light mb-1 block tracking-wide">비밀번호 확인 *</label>
            <input id="reg-password-confirm" type="password" placeholder="비밀번호를 다시 입력해주세요" autocomplete="new-password"
              class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          </div>
          <div>
            <label class="text-xs text-brand-light mb-1 block tracking-wide">닉네임 *</label>
            <input id="reg-nickname" type="text" placeholder="2자 이상"
              class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          </div>
          <div>
            <label class="text-xs text-brand-light mb-1 block tracking-wide">이메일 (선택)</label>
            <input id="reg-email" type="email" placeholder="example@email.com"
              class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          </div>
          <div>
            <label class="text-xs text-brand-light mb-1 block tracking-wide">연락처 (선택)</label>
            <input id="reg-phone" type="tel" placeholder="010-0000-0000"
              class="w-full px-4 py-3.5 border border-brand-border text-sm tracking-wide" />
          </div>

          <p id="register-error" class="text-red-500 text-xs text-center hidden"></p>

          <button type="submit" class="w-full py-3.5 bg-brand text-white text-sm font-medium tracking-wider mt-2 hover:bg-black transition-colors">
            가입하기
          </button>

          <!-- Divider -->
          <div class="flex items-center gap-4 my-4">
            <div class="flex-1 divider"></div>
            <span class="text-xs text-brand-muted">또는</span>
            <div class="flex-1 divider"></div>
          </div>

          <!-- Kakao Register -->
          <button type="button" id="kakao-register-btn" onclick="handleKakaoLogin()" class="kakao-btn w-full py-3.5 text-sm font-medium tracking-wide flex items-center justify-center gap-2 hidden">
            <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#000" d="M9 1C4.58 1 1 3.79 1 7.21c0 2.17 1.44 4.08 3.62 5.17-.16.56-.57 2.03-.66 2.35-.1.39.15.39.31.28.13-.08 2.01-1.36 2.82-1.91.6.09 1.22.13 1.85.13 4.42 0 8-2.79 8-6.23C17 3.79 13.42 1 9 1"/></svg>
            카카오로 간편가입
          </button>
        </form>

        <p class="text-[10px] text-brand-muted text-center mt-6 mb-8 leading-relaxed">
          가입 시 LUEUR의 <a href="/api/privacy" target="_blank" class="underline">개인정보처리방침</a>에 동의합니다.
        </p>
      </div>
    </div>
  </div>

  <!-- Main Screen (after login) -->
  <div id="main-screen" class="flex-1 flex flex-col hidden">
    <!-- Header -->
    <header class="flex items-center justify-between px-5 py-4 border-b border-brand-border bg-white sticky top-0 z-10">
      <h1 class="font-brand text-xl tracking-wider">LUEUR</h1>
      <div class="flex items-center gap-3">
        <img id="header-profile-img" class="w-7 h-7 rounded-full object-cover hidden" alt="" />
        <span id="header-nickname" class="text-xs text-brand-light"></span>
        <button onclick="logout()" class="text-xs text-brand-muted hover:text-red-500 transition-colors">로그아웃</button>
      </div>
    </header>

    <!-- Content -->
    <div class="flex-1 flex flex-col items-center justify-center px-8 text-center">
      <!-- Profile Image -->
      <div id="profile-image-wrap" class="w-20 h-20 rounded-full overflow-hidden mb-5 border border-brand-border">
        <div id="profile-image-placeholder" class="w-full h-full bg-gray-100 flex items-center justify-center text-2xl text-brand-muted">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        </div>
        <img id="profile-image" class="w-full h-full object-cover hidden" alt="프로필" />
      </div>
      <div class="font-brand text-3xl tracking-wider mb-3">Welcome</div>
      <p id="welcome-msg" class="text-sm text-brand-light mb-6"></p>
      <div class="w-16 divider mb-6"></div>
      <p class="text-xs text-brand-muted leading-relaxed">
        상품 목록, 장바구니 등<br/>다음 기능들이 곧 추가될 예정입니다.
      </p>

      <!-- User Info Card -->
      <div class="mt-8 w-full border border-brand-border p-5 text-left">
        <h3 class="text-xs text-brand-muted tracking-widest uppercase mb-4">My Account</h3>
        <div class="space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-brand-muted">닉네임</span>
            <span id="info-nickname" class="font-medium"></span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-brand-muted">아이디</span>
            <span id="info-username" class="font-medium"></span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-brand-muted">이메일</span>
            <span id="info-email" class="font-medium"></span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-brand-muted">가입방법</span>
            <span id="info-provider" class="font-medium"></span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-brand-muted">가입일</span>
            <span id="info-date" class="font-medium"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-brand text-white text-sm px-5 py-2.5 shadow-lg hidden z-50 tracking-wide"></div>

<script>
// --- State ---
let token = localStorage.getItem('lueur_token');
let currentUser = null;
let kakaoConfig = null;

// --- API Helper ---
async function api(method, url, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (token) opts.headers['Authorization'] = `Bearer ${token}`;
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || '요청 실패');
  return data;
}

// --- Toast ---
function toast(msg, isError = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `fixed top-4 left-1/2 -translate-x-1/2 text-white text-sm px-5 py-2.5 shadow-lg z-50 tracking-wide ${isError ? 'bg-red-500' : 'bg-brand'}`;
  setTimeout(() => el.classList.add('hidden'), 2500);
}

// --- Page Navigation ---
function showPage(page) {
  document.getElementById('page-login').classList.add('hidden');
  document.getElementById('page-register').classList.add('hidden');

  if (page === 'login') {
    document.getElementById('page-login').classList.remove('hidden');
    document.getElementById('login-error').classList.add('hidden');
  } else if (page === 'register') {
    document.getElementById('page-register').classList.remove('hidden');
    document.getElementById('register-error').classList.add('hidden');
  }
}

// --- Auth ---
async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) {
    showError('login-error', '아이디와 비밀번호를 입력해주세요');
    return;
  }
  try {
    const res = await api('POST', '/api/auth/login', { username, password });
    token = res.data.token;
    localStorage.setItem('lueur_token', token);
    currentUser = res.data.user;
    showMainScreen();
    toast(`${currentUser.nickname}님, 환영합니다`);
  } catch (err) {
    showError('login-error', err.message);
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const passwordConfirm = document.getElementById('reg-password-confirm').value;
  const nickname = document.getElementById('reg-nickname').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const phone = document.getElementById('reg-phone').value.trim();

  if (!username || !password || !nickname) {
    showError('register-error', '필수 항목을 모두 입력해주세요');
    return;
  }
  if (username.length < 4) {
    showError('register-error', '아이디는 4자 이상이어야 합니다');
    return;
  }
  if (password.length < 6) {
    showError('register-error', '비밀번호는 6자 이상이어야 합니다');
    return;
  }
  if (password !== passwordConfirm) {
    showError('register-error', '비밀번호가 일치하지 않습니다');
    return;
  }
  if (nickname.length < 2) {
    showError('register-error', '닉네임은 2자 이상이어야 합니다');
    return;
  }

  try {
    const res = await api('POST', '/api/auth/register', { username, password, nickname, email: email || undefined, phone: phone || undefined });
    token = res.data.token;
    localStorage.setItem('lueur_token', token);
    currentUser = res.data.user;
    showMainScreen();
    toast('가입을 환영합니다!');
  } catch (err) {
    showError('register-error', err.message);
  }
}

function handleKakaoLogin() {
  if (!kakaoConfig || !kakaoConfig.enabled) {
    toast('카카오 로그인이 설정되지 않았습니다', true);
    return;
  }
  const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=${kakaoConfig.clientId}&redirect_uri=${encodeURIComponent(kakaoConfig.redirectUri)}&response_type=code`;
  window.location.href = kakaoAuthUrl;
}

function logout() {
  token = null;
  currentUser = null;
  localStorage.removeItem('lueur_token');
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('main-screen').classList.add('hidden');
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  showPage('login');
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.classList.remove('hidden');
}

// --- Main Screen ---
function showMainScreen() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('main-screen').classList.remove('hidden');
  document.getElementById('header-nickname').textContent = currentUser.nickname;
  document.getElementById('welcome-msg').textContent = `${currentUser.nickname}님의 뷰티 여정이 시작됩니다.`;

  // Profile image
  const profileImg = document.getElementById('profile-image');
  const profilePlaceholder = document.getElementById('profile-image-placeholder');
  const headerImg = document.getElementById('header-profile-img');
  if (currentUser.profile_image) {
    profileImg.src = currentUser.profile_image;
    profileImg.classList.remove('hidden');
    profilePlaceholder.classList.add('hidden');
    headerImg.src = currentUser.profile_image;
    headerImg.classList.remove('hidden');
  } else {
    profileImg.classList.add('hidden');
    profilePlaceholder.classList.remove('hidden');
    headerImg.classList.add('hidden');
  }

  // User info card
  document.getElementById('info-nickname').textContent = currentUser.nickname;
  document.getElementById('info-username').textContent = currentUser.username || '-';
  document.getElementById('info-email').textContent = currentUser.email || '-';
  document.getElementById('info-provider').textContent = currentUser.provider === 'kakao' ? '카카오' : '일반';
  document.getElementById('info-date').textContent = currentUser.created_at
    ? new Date(currentUser.created_at).toLocaleDateString('ko-KR')
    : '-';
}

// --- Handle Hash Routes ---
function handleHash() {
  const hash = window.location.hash;

  // Kakao callback: /#/kakao-callback?token=xxx
  if (hash.startsWith('#/kakao-callback')) {
    const params = new URLSearchParams(hash.split('?')[1] || '');
    const kakaoToken = params.get('token');
    if (kakaoToken) {
      token = kakaoToken;
      localStorage.setItem('lueur_token', token);
      window.location.hash = '';
      initApp();
      return;
    }
  }

  // Login error: /#/login?error=xxx
  if (hash.startsWith('#/login')) {
    const params = new URLSearchParams(hash.split('?')[1] || '');
    const error = params.get('error');
    if (error) {
      showPage('login');
      showError('login-error', decodeURIComponent(error));
      window.location.hash = '';
    }
  }
}

// --- Init ---
async function loadKakaoConfig() {
  try {
    const res = await api('GET', '/api/auth/kakao/config');
    kakaoConfig = res.data;
    if (kakaoConfig.enabled) {
      document.getElementById('kakao-login-btn').classList.remove('hidden');
      document.getElementById('kakao-register-btn').classList.remove('hidden');
    }
  } catch (err) {
    console.error('Kakao config load error:', err);
  }
}

async function initApp() {
  await loadKakaoConfig();

  if (!token) {
    handleHash();
    return;
  }
  try {
    const res = await api('GET', '/api/auth/me');
    currentUser = res.data;
    showMainScreen();
  } catch {
    logout();
  }
}

window.addEventListener('hashchange', handleHash);
initApp();
</script>
</body>
</html>
